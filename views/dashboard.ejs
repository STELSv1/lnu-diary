<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | LNU Diary</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <% 
        const safeSubjects = (typeof subjects !== 'undefined') ? subjects : [];
        const safeUser = (typeof user !== 'undefined') ? user : { name: 'Гість', email: '' };
        const safeSubgroup = (typeof userSubgroup !== 'undefined') ? userSubgroup : 1;
        const safeSummary = (typeof summary !== 'undefined') ? summary : [];
        const safeTasks = (typeof tasks !== 'undefined') ? tasks : [];
        const safeSchedule = (typeof schedule !== 'undefined') ? schedule : [];
        let activeTab = (typeof currentTab !== 'undefined') ? currentTab : 'grades';

        // Функції для серверного рендерингу
        function getECTS(score) {
            if (score >= 90) return 'A';
            if (score >= 81) return 'B';
            if (score >= 71) return 'C';
            if (score >= 61) return 'D';
            if (score >= 51) return 'E';
            return 'F';
        }
        function getColor(score) {
            if (score >= 81) return '#00ffcc';
            if (score >= 71) return '#ffcc00';
            if (score >= 51) return '#ff8800';
            return '#ff5555';
        }
    %>

    <header>
        <div style="font-weight:bold; font-size:1.2em; color: #00ffcc;">
            <i class="fas fa-graduation-cap"></i> LNU Diary
        </div>
        <div>
            <span><%= safeUser.name || safeUser.email %></span>
            <a href="/auth/logout" style="color:#ff5555; margin-left:15px; font-weight: bold;">
                <i class="fas fa-sign-out-alt"></i> Вихід
            </a>
        </div>
    </header>

    <div class="container">
        
        <div class="tabs-nav">
            <button id="btn-grades" class="tab-btn" onclick="openTab('grades')">
                <i class="fas fa-chart-bar"></i> Оцінки
            </button>
            <button id="btn-planner" class="tab-btn" onclick="openTab('planner')">
                <i class="fas fa-tasks"></i> Планувальник
            </button>
            <button id="btn-schedule" class="tab-btn" onclick="openTab('schedule')">
                <i class="far fa-calendar-alt"></i> Розклад
            </button>
        </div>

       
        <div id="tab-grades" class="tab-content">
            <select class="subject-select" onchange="fetchGrades(this.value)">
                <option value="all">Загальний підсумок</option>
                <% safeSubjects.forEach(sub => { %>
                    <option value="<%= sub.id %>"><%= sub.name %></option>
                <% }) %>
            </select>

           
            <div id="grades-summary-view" style="display: block;">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th>Предмет</th>
                            <th>Лаби</th>
                            <th>Модулі</th>
                            <th>Екзамен</th>
                            <th>Підсумок</th>
                            <th>ECTS</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body">
                        <% if (safeSummary.length > 0) { %>
                            <% safeSummary.forEach(row => { 
                                const ects = getECTS(row.total);
                                const color = getColor(row.total);
                            %>
                                <tr>
                                    <td style="text-align:left; font-weight:bold"><%= row.subject_name %></td>
                                    <td><%= row.labs %></td>
                                    <td><%= row.modules %></td>
                                    <td><%= row.exam %></td> 
                                    <td style="font-weight:bold; font-size:1.1em; color: <%= color %>"><%= row.total %></td>
                                    <td style="font-weight:bold; font-size:1.1em; color: <%= color %>"><%= ects %></td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="6" style="color:#666; padding:20px;">Оцінок немає</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

          
            <div id="grades-detail-view" style="display: none;">
                <div class="details-grid">
                    <div class="col" id="col-labs">
                        <h3>Лабораторні</h3>
                        <div class="list"></div>
                    </div>
                    <div class="col" id="col-modules">
                        <h3>Модулі</h3>
                        <div class="list"></div>
                    </div>
                    <div class="col" id="col-exam">
                        <h3>Екзамен / Підсумок</h3>
                        <div class="list"></div>
                    </div>
                </div>
            </div>
        </div>

        
        <div id="tab-planner" class="tab-content">
            <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; border: 1px solid #333;">
                <form id="addTaskForm" style="display:flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <input type="text" name="text" id="taskText" placeholder="Що треба зробити?" required style="flex-grow:1; padding:10px; border-radius:4px; border:1px solid #444; background:#222; color:white;">
                    <input type="datetime-local" name="deadline" id="taskDeadline" required style="padding:10px; border-radius:4px; border:1px solid #444; background:#222; color:white;">
                    <button type="submit" style="background:#00ffcc; color:black; font-weight:bold; border:none; padding:10px 20px; cursor:pointer; border-radius:4px;">Додати</button>
                </form>

                <div id="taskList" class="task-list">
                    <% if (safeTasks.length > 0) { %>
                        <% safeTasks.forEach(task => { 
                            let dateStr = '';
                            if (task.deadline) {
                                const d = new Date(task.deadline);
                                dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            }
                        %>
                            <div id="task-<%= task.id %>" style="display:flex; justify-content:space-between; align-items:center; background:#252525; padding:10px; margin-bottom:8px; border-radius:4px; border-left: 3px solid <%= task.is_done ? '#28a745' : '#ffcc00' %>; transition: all 0.3s;">
                                <div class="task-content" style="<%= task.is_done ? 'text-decoration:line-through; color:#777;' : '' %>">
                                    <span style="font-weight:bold;"><%= task.text %></span>
                                    <% if (dateStr) { %>
                                        <span style="color:#888; font-size:0.8em; margin-left:10px;"><i class="far fa-clock"></i> <%= dateStr %></span>
                                    <% } %>
                                </div>
                                <div>
                                    <button onclick="toggleTask(<%= task.id %>)" style="background:none; border:none; cursor:pointer; color:#00ffcc; font-size:1.2em;"><i class="<%= task.is_done ? 'fas fa-check-circle' : 'far fa-circle' %>" id="icon-<%= task.id %>"></i></button>
                                    <button onclick="deleteTask(<%= task.id %>)" style="background:none; border:none; cursor:pointer; color:#ff5555; font-size:1.2em;"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p id="noTasksMsg" style="text-align:center; color:#666;">Завдань немає.</p>
                    <% } %>
                </div>
            </div>
        </div>

        <div id="tab-schedule" class="tab-content">
            <div style="margin-bottom: 20px; display:flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0; color:#00ffcc;">Розклад занять</h3>
                <select id="subgroupSelect" onchange="changeSubgroup(this.value)" style="padding:5px; background:#333; color:white; border:1px solid #555; border-radius:4px;">
                    <option value="1" <%= safeSubgroup === 1 ? 'selected' : '' %>>Підгрупа 1</option>
                    <option value="2" <%= safeSubgroup === 2 ? 'selected' : '' %>>Підгрупа 2</option>
                </select>
            </div>

            <div id="schedule-container" class="schedule-container" style="background: #1e1e1e; padding: 20px; border-radius: 8px; border: 1px solid #333;">
                <% if (safeSchedule.length > 0) { %>
                    <% 
                        let currentDay = '';
                        safeSchedule.forEach(lesson => { 
                            if (currentDay !== lesson.day_name) {
                                currentDay = lesson.day_name;
                    %>
                        <div style="background:#2f2f2f; color:#00ffcc; padding:8px; font-weight:bold; margin-top:15px; border-radius:4px;">
                            <%= currentDay %>
                        </div>
                    <% } %>
                        <div style="display:flex; padding:10px 0; border-bottom:1px dashed #444;">
                            <div style="width:60px; color:#888; font-family:monospace;"><%= lesson.time_start %></div>
                            <div style="flex-grow:1;">
                                <div style="color:white;"><%= lesson.subject %></div>
                                <div style="color:#666; font-size:0.9em;">Пара <%= lesson.lesson_num %></div>
                            </div>
                            <div style="color:#ffcc00; font-weight:bold;"><%= lesson.room %></div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p style="text-align:center; color:#666;">Розклад порожній. Перевірте базу даних.</p>
                <% } %>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('taskDeadline');
            if (dateInput) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                dateInput.min = now.toISOString().slice(0, 16);
            }
            openTab('<%= activeTab %>');
        });

     
        function getECTS(score) {
            if (score >= 90) return 'A';
            if (score >= 81) return 'B';
            if (score >= 71) return 'C';
            if (score >= 61) return 'D';
            if (score >= 51) return 'E';
            return 'F';
        }

       
        function getColor(score) {
            if (score >= 81) return '#00ffcc';
            if (score >= 71) return '#ffcc00';
            if (score >= 51) return '#ff8800';
            return '#ff5555';
        }
 
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const target = document.getElementById('tab-' + tabName);
            const btn = document.getElementById('btn-' + tabName);
            if (target) target.style.display = 'block';
            if (btn) btn.classList.add('active');
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.replaceState({}, '', url);
        }

       
        async function changeSubgroup(subgroup) {
            try {
                const response = await fetch('/set-subgroup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subgroup })
                });
                const result = await response.json();
                if (result.success) {
                    renderSchedule(result.schedule);
                } else {
                    console.error("Помилка зміни підгрупи");
                }
            } catch (err) { console.error(err); }
        }

        function renderSchedule(schedule) {
            const container = document.getElementById('schedule-container');
            if (!schedule || schedule.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">Розклад порожній.</p>';
                return;
            }
            let html = '';
            let currentDay = '';
            schedule.forEach(lesson => {
                if (currentDay !== lesson.day_name) {
                    currentDay = lesson.day_name;
                    html += `<div style="background:#2f2f2f; color:#00ffcc; padding:8px; font-weight:bold; margin-top:15px; border-radius:4px;">${currentDay}</div>`;
                }
                html += `
                    <div style="display:flex; padding:10px 0; border-bottom:1px dashed #444;">
                        <div style="width:60px; color:#888; font-family:monospace;">${lesson.time_start}</div>
                        <div style="flex-grow:1;">
                            <div style="color:white;">${lesson.subject}</div>
                            <div style="color:#666; font-size:0.9em;">Пара ${lesson.lesson_num}</div>
                        </div>
                        <div style="color:#ffcc00; font-weight:bold;">${lesson.room}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

   
        async function fetchGrades(subjectId) {
            try {
                const response = await fetch(`/api/grades?subject_id=${subjectId}`);
                const result = await response.json();

                const summaryView = document.getElementById('grades-summary-view');
                const detailView = document.getElementById('grades-detail-view');

                const triggerFade = (element) => {
                    element.style.animation = 'none';
                    element.offsetHeight; 
                    element.style.animation = 'fadeIn 0.5s ease-in-out';
                };

                if (result.mode === 'summary') {
                 
                    summaryView.style.display = 'block';
                    detailView.style.display = 'none';
                    
                    let html = '';
                    if (result.data.length === 0) {
                        html = '<tr><td colspan="6" style="color:#666; padding:20px;">Оцінок немає</td></tr>';
                    } else {
                        result.data.forEach(row => {
                            const ects = getECTS(row.total);
                            const color = getColor(row.total);
                            html += `
                                <tr>
                                    <td style="text-align:left; font-weight:bold">${row.subject_name}</td>
                                    <td>${row.labs}</td>
                                    <td>${row.modules}</td>
                                    <td>${row.exam}</td>
                                    <td style="font-weight:bold; font-size:1.1em; color: ${color}">${row.total}</td>
                                    <td style="font-weight:bold; font-size:1.1em; color: ${color}">${ects}</td>
                                </tr>
                            `;
                        });
                    }
                    document.getElementById('summary-body').innerHTML = html;
                    triggerFade(summaryView);

                } else {
                  
                    summaryView.style.display = 'none';
                    detailView.style.display = 'block';

                    const d = result.data;
                    const renderList = (items, defaultName) => {
                        return items.map(i => `<div class="row"><span>${i.name || defaultName}</span> <span>${i.score}</span></div>`).join('');
                    };

                    const labCol = document.getElementById('col-labs');
                    labCol.querySelector('.list').innerHTML = renderList(d.labs, 'Лаб');
                    
                    const modCol = document.getElementById('col-modules');
                    modCol.querySelector('.list').innerHTML = renderList(d.modules, 'Модуль');
                    
                    const examCol = document.getElementById('col-exam');
                    let examHtml = renderList(d.exam, 'Екзамен');
                    
                    const totalEcts = getECTS(d.totalSum);
                    const totalColor = getColor(d.totalSum);
                    
                   
                    examHtml += `<br><div class="row" style="color:${totalColor}; font-weight:bold;"><span>Всього</span> <span>${d.totalSum} (${totalEcts})</span></div>`;
                    
                    examCol.querySelector('.list').innerHTML = examHtml;
                    triggerFade(detailView);
                }
            } catch (err) { console.error("Error:", err); }
        }

        const addForm = document.getElementById('addTaskForm');
        if (addForm) {
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = document.getElementById('taskText').value;
                const deadline = document.getElementById('taskDeadline').value;
                try {
                    const response = await fetch('/tasks/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, deadline })
                    });
                    const data = await response.json();
                    if (data.error) {
                        alert(data.error);
                    } else if (data.success) {
                        document.getElementById('taskText').value = '';
                        location.reload(); 
                    }
                } catch (err) { console.error('Error:', err); }
            });
        }

        async function deleteTask(id) {
            try {
                await fetch('/tasks/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) });
                document.getElementById('task-' + id).remove();
            } catch (e) {}
        }
        async function toggleTask(id) {
             try {
                await fetch('/tasks/toggle', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) });
                location.reload(); 
            } catch (e) {}
        }
    </script>
</body>
</html>